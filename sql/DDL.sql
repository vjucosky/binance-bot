USE STUDY

/*
	DROP TABLE IF EXISTS BINANCE_SYMBOL_AGGTRADE
	DROP TABLE IF EXISTS BINANCE_SYMBOL_TRADE
	DROP TABLE IF EXISTS BINANCE_SYMBOL_KLINE
	DROP TABLE IF EXISTS BINANCE_SYMBOL

	DROP FUNCTION IF EXISTS dbo.FROM_UNIX_TIMESTAMP

	DROP TABLE IF EXISTS BINANCE_DATASET_KLINE
*/

CREATE TABLE BINANCE_SYMBOL (
	ID bigint IDENTITY(1, 1) NOT NULL,
	[NAME] varchar(40) NOT NULL,
	BASE_ASSET_NAME varchar(20) NOT NULL,
	BASE_ASSET_PRECISION integer NOT NULL,
	QUOTE_ASSET_NAME varchar(20) NOT NULL,
	QUOTE_ASSET_PRECISION integer NOT NULL,
	IS_ICEBERG_ALLOWED bit NOT NULL,
	IS_OCO_ALLOWED bit NOT NULL,
	IS_SPOT_TRADING_ALLOWED bit NOT NULL,
	IS_MARGIN_TRADING_ALLOWED bit NOT NULL,
	CREATED_AT datetime NOT NULL CONSTRAINT DF__BINANCE_SYMBOL__CREATED_AT DEFAULT GETDATE(),
	UPDATED_AT datetime,

	CONSTRAINT PK__BINANCE_SYMBOL__ID PRIMARY KEY (ID),
	CONSTRAINT UQ__BINANCE_SYMBOL__NAME UNIQUE ([NAME]),
	CONSTRAINT UQ__BINANCE_SYMBOL__BASE_ASSET_NAME__QUOTE_ASSET_NAME UNIQUE (BASE_ASSET_NAME, QUOTE_ASSET_NAME)
)

CREATE TABLE BINANCE_SYMBOL_KLINE (
	ID bigint IDENTITY(1, 1) NOT NULL,
	SYMBOL_ID bigint NOT NULL,

	TRADE_COUNT integer NOT NULL,
	OPEN_VALUE decimal(18, 8) NOT NULL,
	HIGH_VALUE decimal(18, 8) NOT NULL,
	LOW_VALUE decimal(18, 8) NOT NULL,
	CLOSE_VALUE decimal(18, 8) NOT NULL,
	BASE_ASSET_VOLUME decimal(18, 8) NOT NULL,
	BASE_ASSET_TAKER_BUY_VOLUME decimal(18, 8) NOT NULL,
	QUOTE_ASSET_VOLUME decimal(18, 8) NOT NULL,
	QUOTE_ASSET_TAKER_BUY_VOLUME decimal(18, 8) NOT NULL,
	OPEN_TIMESTAMP bigint NOT NULL,
	CLOSE_TIMESTAMP bigint NOT NULL,
	CREATED_AT datetime NOT NULL CONSTRAINT DF__BINANCE_SYMBOL_KLINE__CREATED_AT DEFAULT GETDATE(),

	CONSTRAINT PK__BINANCE_SYMBOL_KLINE__ID PRIMARY KEY (ID),
	CONSTRAINT FK__BINANCE_SYMBOL_KLINE__SYMBOL_ID FOREIGN KEY (SYMBOL_ID) REFERENCES BINANCE_SYMBOL(ID),
	INDEX IX__BINANCE_SYMBOL_KLINE__SYMBOL_ID (SYMBOL_ID)
)

CREATE TABLE BINANCE_SYMBOL_TRADE (
	ID bigint IDENTITY(1, 1) NOT NULL,
	SYMBOL_ID bigint NOT NULL,

	NUMBER bigint NOT NULL,
	[VALUE] decimal(18, 8) NOT NULL,
	ASSET_QUANTITY decimal(18, 8) NOT NULL,
	ASSET_PRICE decimal(18, 8) NOT NULL,
	IS_BUYER_MAKER bit NOT NULL,
	IS_BEST_MATCH bit NOT NULL,
	EXECUTION_TIMESTAMP bigint NOT NULL,
	CREATED_AT datetime NOT NULL CONSTRAINT DF__BINANCE_SYMBOL_TRADE__CREATED_AT DEFAULT GETDATE(),

	CONSTRAINT PK__BINANCE_SYMBOL_TRADE__ID PRIMARY KEY (ID),
	CONSTRAINT FK__BINANCE_SYMBOL_TRADE__SYMBOL_ID FOREIGN KEY (SYMBOL_ID) REFERENCES BINANCE_SYMBOL(ID),
	INDEX IX__BINANCE_SYMBOL_TRADE__SYMBOL_ID (SYMBOL_ID)
)

CREATE TABLE BINANCE_SYMBOL_AGGTRADE (
	ID bigint IDENTITY(1, 1) NOT NULL,
	SYMBOL_ID bigint NOT NULL,

	NUMBER integer NOT NULL,
	FIRST_TRADE_NUMBER bigint NOT NULL,
	LAST_TRADE_NUMBER bigint NOT NULL,
	ASSET_QUANTITY decimal(18, 8) NOT NULL,
	ASSET_PRICE decimal(18, 8) NOT NULL,
	IS_BUYER_MAKER bit NOT NULL,
	IS_BEST_MATCH bit NOT NULL,
	EXECUTION_TIMESTAMP bigint NOT NULL,
	CREATED_AT datetime NOT NULL CONSTRAINT DF__BINANCE_SYMBOL_AGGTRADE__CREATED_AT DEFAULT GETDATE(),

	CONSTRAINT PK__BINANCE_SYMBOL_AGGTRADE__ID PRIMARY KEY (ID),
	CONSTRAINT FK__BINANCE_SYMBOL_AGGTRADE__SYMBOL_ID FOREIGN KEY (SYMBOL_ID) REFERENCES BINANCE_SYMBOL(ID),
	INDEX IX__BINANCE_SYMBOL_AGGTRADE__SYMBOL_ID (SYMBOL_ID)
)

CREATE FUNCTION dbo.FROM_UNIX_TIMESTAMP (@TIMESTAMP AS bigint)
RETURNS datetime2
AS
BEGIN
	RETURN DATEADD(MILLISECOND, @TIMESTAMP % 1000, DATEADD(SECOND, (@TIMESTAMP / 1000) % 60, DATEADD(MINUTE, ((@TIMESTAMP / 1000) / 60) % 60, DATEADD(HOUR, ((@TIMESTAMP / 1000) / 60) / 60, CAST('1970-01-01' AS datetime2)))))
END

/*
	As tabelas BINANCE_DATASET_* são carregadas de acordo com os parâmetros desejados para o treinamento do modelo.

	Cada dataset contém um ID de agrupamento (coluna DATASET_NUMBER) e um número de linha (coluna DATASET_ROW)
	para facilitar a ordenação. Note que as linhas são ordenadas em ordem decrescente (a mais recente será a primeira).

	A carga só é feita par a par, devido à volumetria.
*/

CREATE TABLE BINANCE_DATASET_KLINE (
	ID bigint IDENTITY(1, 1) NOT NULL,
	DATASET_NUMBER bigint NOT NULL,
	DATASET_ROW bigint NOT NULL,
	TRADE_COUNT integer NOT NULL,
	OPEN_VALUE decimal(18, 8) NOT NULL,
	HIGH_VALUE decimal(18, 8) NOT NULL,
	LOW_VALUE decimal(18, 8) NOT NULL,
	CLOSE_VALUE decimal(18, 8) NOT NULL,
	BASE_ASSET_VOLUME decimal(18, 8) NOT NULL,
	BASE_ASSET_TAKER_BUY_VOLUME decimal(18, 8) NOT NULL,
	QUOTE_ASSET_VOLUME decimal(18, 8) NOT NULL,
	QUOTE_ASSET_TAKER_BUY_VOLUME decimal(18, 8) NOT NULL,
	OPEN_TIMESTAMP bigint NOT NULL,
	CLOSE_TIMESTAMP bigint NOT NULL,
	CREATED_AT datetime NOT NULL CONSTRAINT DF__BINANCE_DATASET_KLINE__CREATED_AT DEFAULT GETDATE(),

	CONSTRAINT PK__BINANCE_DATASET_KLINE__ID PRIMARY KEY (ID)
)
